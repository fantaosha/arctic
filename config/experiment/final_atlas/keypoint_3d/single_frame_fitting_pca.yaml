# @package _global_
defaults:
  - override /model: final_atlas
  - override /factors: keypoint_sparse_2d

result_folder: final_atlas/sparse/${person}
init_file: init_single_frame_results.pkl
result_file: single_frame_results.pkl

init_damping_ratio: 0.1
init_damping_const: 0.2
max_damping_ratio: 250
batch_size: 640

problem: "single_frame_fitting"

shape_pca_weight: 50
scale_pca_weight: 1.5
hand_pca_weight: 0.1

filters:
  smooth:
    reprojected: True

init_optim:
  shared_params:
    optimizer:
      _target_: mesh_fitting.optim.optim.optimize_single_frames
      _partial_: True
      init_damping_ratio: ${init_damping_ratio}
      init_damping_const: ${init_damping_const}
      max_damping_ratio: ${max_damping_ratio}
    stages:
      0:
        params:
          cameras_ext:
            opt_idxs: ~
            shared_idxs: ~
          shape_params:
            transform: shape
            opt_idxs: ${shape_param_idxs.full}
            shared_idxs: ${shape_param_idxs.full}
          skel_params:
            transform: pca
            opt_idxs: ${skel_param_idxs.pca.scale_root}
            shared_idxs: ${skel_param_idxs.pca.scale}
        factors: ${body_factors.scale_pca.s3}
        max_iters: 3
      1:
        params:
          shape_params:
            transform: shape
            opt_idxs: ${shape_param_idxs.full}
            shared_idxs: ${shape_param_idxs.full}
          skel_params:
            transform: pca
            opt_idxs: ${skel_param_idxs.pca.scale_root}
            shared_idxs: ${skel_param_idxs.pca.scale}
        factors: ${body_factors.full_pca.s2}
        max_iters: 3

optim:
  init: ~
  all_cameras:
    optimizer:
      _target_: mesh_fitting.optim.optim.optimize_single_frames
      _partial_: True
      init_damping_ratio: ${init_damping_ratio}
      init_damping_const: ${init_damping_const}
      max_damping_ratio: ${max_damping_ratio}
    stages:
      0:
        params:
          cameras_ext:
            opt_idxs: ~
            shared_idxs: ~
          skel_params:
            transform: pca
            opt_idxs: ${skel_param_idxs.pca.full_joint}
            shared_idxs: ~
        factors: ${body_factors.full_pca.s3}
        max_iters: 3

  refine_hand:
    optimizer:
      _target_: mesh_fitting.optim.optim.optimize_single_frames
      _partial_: True
      init_damping_ratio: ${init_damping_ratio}
      init_damping_const: ${init_damping_const}
      max_damping_ratio: ${max_damping_ratio}
    stages:
      0:
        params:
          cameras_ext:
            opt_idxs: ~
            shared_idxs: ~
          skel_params:
            transform: pca
            opt_idxs: ${skel_param_idxs.pca.full_joint}
            shared_idxs: ~
        factors: ${body_factors.refine_pca.s0}
        max_iters: 3
      1:
        params:
          cameras_ext:
            opt_idxs: ~
            shared_idxs: ~
          skel_params:
            transform: pca
            opt_idxs: ${skel_param_idxs.pca.full_joint}
            shared_idxs: ~
        factors: ${body_factors.refine_pca.s1}
        max_iters: 3
